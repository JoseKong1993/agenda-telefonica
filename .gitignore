import java.io.*;
import java.util.*;

/**
 * Clase AddressBook que representa una agenda telef√≥nica
 * Almacena contactos en un HashMap y los persiste en un archivo CSV
 * 
 * Actividad 4 - Tema 12
 * Programaci√≥n en Java
 */
public class AddressBook {
    private HashMap<String, String> contacts;
    private final String fileName;
    private Scanner scanner;

    /**
     * Constructor de la clase AddressBook
     * @param fileName nombre del archivo donde se almacenar√°n los contactos
     */
    public AddressBook(String fileName) {
        this.contacts = new HashMap<>();
        this.fileName = fileName;
        this.scanner = new Scanner(System.in);
        load(); // Cargar contactos existentes al inicializar
    }

    /**
     * Carga los contactos desde el archivo CSV
     * Formato esperado: numero,nombre
     */
    public void load() {
        try (BufferedReader reader = new BufferedReader(new FileReader(fileName))) {
            String line;
            int count = 0;
            
            while ((line = reader.readLine()) != null) {
                if (!line.trim().isEmpty()) {
                    String[] parts = line.split(",", 2);
                    if (parts.length == 2) {
                        contacts.put(parts[0].trim(), parts[1].trim());
                        count++;
                    }
                }
            }
            
            if (count > 0) {
                System.out.println("‚úÖ Se cargaron " + count + " contactos desde " + fileName);
            }
            
        } catch (FileNotFoundException e) {
            System.out.println("üìù Archivo no encontrado. Se crear√° uno nuevo: " + fileName);
        } catch (IOException e) {
            System.err.println("‚ùå Error al leer el archivo: " + e.getMessage());
        }
    }

    /**
     * Guarda los contactos actuales en el archivo CSV
     * Formato: numero,nombre
     */
    public void save() {
        try (PrintWriter writer = new PrintWriter(new FileWriter(fileName))) {
            for (Map.Entry<String, String> entry : contacts.entrySet()) {
                writer.println(entry.getKey() + "," + entry.getValue());
            }
            System.out.println("üíæ Contactos guardados exitosamente en " + fileName);
        } catch (IOException e) {
            System.err.println("‚ùå Error al guardar el archivo: " + e.getMessage());
        }
    }

    /**
     * Muestra todos los contactos de la agenda
     */
    public void list() {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("üìû LISTA DE CONTACTOS");
        System.out.println("=".repeat(50));
        
        if (contacts.isEmpty()) {
            System.out.println("üì≠ No hay contactos en la agenda.");
            return;
        }

        System.out.print("Contactos: ");
        boolean first = true;
        
        // Ordenar contactos por nombre para mejor presentaci√≥n
        List<Map.Entry<String, String>> sortedContacts = new ArrayList<>(contacts.entrySet());
        sortedContacts.sort(Map.Entry.comparingByValue());
        
        for (Map.Entry<String, String> entry : sortedContacts) {
            if (!first) {
                System.out.print(" ");
            }
            System.out.print("{" + entry.getKey() + "} : {" + entry.getValue() + "}");
            first = false;
        }
        
        System.out.println("\n" + "=".repeat(50));
        System.out.println("Total de contactos: " + contacts.size());
    }

    /**
     * Crea un nuevo contacto
     */
    public void create() {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("‚ûï CREAR NUEVO CONTACTO");
        System.out.println("=".repeat(50));
        
        System.out.print("Ingrese el n√∫mero telef√≥nico: ");
        String phoneNumber = scanner.nextLine().trim();
        
        if (phoneNumber.isEmpty()) {
            System.out.println("‚ùå El n√∫mero telef√≥nico no puede estar vac√≠o.");
            return;
        }
        
        // Validaci√≥n b√°sica del n√∫mero
        if (!isValidPhoneNumber(phoneNumber)) {
            System.out.println("‚ùå Formato de n√∫mero inv√°lido. Use solo n√∫meros, espacios, guiones o par√©ntesis.");
            return;
        }
        
        if (contacts.containsKey(phoneNumber)) {
            System.out.println("‚ö†Ô∏è Ya existe un contacto con este n√∫mero: " + contacts.get(phoneNumber));
            System.out.print("¬øDesea actualizar el contacto? (s/n): ");
            String response = scanner.nextLine().trim().toLowerCase();
            
            if (!response.equals("s") && !response.equals("si")) {
                System.out.println("‚ùå Operaci√≥n cancelada.");
                return;
            }
        }
        
        System.out.print("Ingrese el nombre del contacto: ");
        String name = scanner.nextLine().trim();
        
        if (name.isEmpty()) {
            System.out.println("‚ùå El nombre no puede estar vac√≠o.");
            return;
        }
        
        contacts.put(phoneNumber, name);
        save(); // Guardar autom√°ticamente
        
        System.out.println("‚úÖ Contacto creado/actualizado exitosamente:");
        System.out.println("   üì± " + phoneNumber + " - " + name);
    }

    /**
     * Elimina un contacto de la agenda
     */
    public void delete() {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("üóëÔ∏è ELIMINAR CONTACTO");
        System.out.println("=".repeat(50));
        
        if (contacts.isEmpty()) {
            System.out.println("üì≠ No hay contactos para eliminar.");
            return;
        }
        
        System.out.print("Ingrese el n√∫mero telef√≥nico a eliminar: ");
        String phoneNumber = scanner.nextLine().trim();
        
        if (contacts.containsKey(phoneNumber)) {
            String name = contacts.get(phoneNumber);
            
            System.out.println("Se eliminar√° el contacto:");
            System.out.println("   üì± " + phoneNumber + " - " + name);
            System.out.print("¬øEst√° seguro? (s/n): ");
            
            String confirmation = scanner.nextLine().trim().toLowerCase();
            
            if (confirmation.equals("s") || confirmation.equals("si")) {
                contacts.remove(phoneNumber);
                save(); // Guardar autom√°ticamente
                System.out.println("‚úÖ Contacto eliminado exitosamente.");
            } else {
                System.out.println("‚ùå Eliminaci√≥n cancelada.");
            }
        } else {
            System.out.println("‚ùå No se encontr√≥ un contacto con el n√∫mero: " + phoneNumber);
        }
    }

    /**
     * Funcionalidad adicional: Buscar contactos
     */
    public void search() {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("üîç BUSCAR CONTACTOS");
        System.out.println("=".repeat(50));
        
        if (contacts.isEmpty()) {
            System.out.println("üì≠ No hay contactos para buscar.");
            return;
        }
        
        System.out.print("Ingrese el t√©rmino de b√∫squeda (nombre o n√∫mero): ");
        String searchTerm = scanner.nextLine().trim().toLowerCase();
        
        if (searchTerm.isEmpty()) {
            System.out.println("‚ùå El t√©rmino de b√∫squeda no puede estar vac√≠o.");
            return;
        }
        
        List<Map.Entry<String, String>> results = new ArrayList<>();
        
        for (Map.Entry<String, String> entry : contacts.entrySet()) {
            if (entry.getKey().toLowerCase().contains(searchTerm) || 
                entry.getValue().toLowerCase().contains(searchTerm)) {
                results.add(entry);
            }
        }
        
        if (results.isEmpty()) {
            System.out.println("‚ùå No se encontraron contactos que coincidan con: " + searchTerm);
        } else {
            System.out.println("‚úÖ Se encontraron " + results.size() + " resultado(s):");
            for (Map.Entry<String, String> entry : results) {
                System.out.println("   üì± " + entry.getKey() + " - " + entry.getValue());
            }
        }
    }

    /**
     * Valida el formato b√°sico del n√∫mero telef√≥nico
     */
    private boolean isValidPhoneNumber(String phoneNumber) {
        // Permite n√∫meros, espacios, guiones, par√©ntesis y el signo +
        return phoneNumber.matches("[\\d\\s\\-\\(\\)\\+]+");
    }

    /**
     * Muestra el men√∫ principal y maneja la interacci√≥n con el usuario
     */
    public void showMenu() {
        boolean running = true;
        
        System.out.println("üì± BIENVENIDO A LA AGENDA TELEF√ìNICA üì±");
        System.out.println("=====================================");
        
        while (running) {
            System.out.println("\n" + "=".repeat(40));
            System.out.println("           MEN√ö PRINCIPAL");
            System.out.println("=".repeat(40));
            System.out.println("1. üìã Listar contactos");
            System.out.println("2. ‚ûï Crear contacto");
            System.out.println("3. üóëÔ∏è  Eliminar contacto");
            System.out.println("4. üîç Buscar contactos");
            System.out.println("5. üíæ Guardar cambios");
            System.out.println("6. üîÑ Recargar desde archivo");
            System.out.println("0. üö™ Salir");
            System.out.println("=".repeat(40));
            System.out.print("Seleccione una opci√≥n: ");
            
            String option = scanner.nextLine().trim();
            
            switch (option) {
                case "1":
                    list();
                    break;
                case "2":
                    create();
                    break;
                case "3":
                    delete();
                    break;
                case "4":
                    search();
                    break;
                case "5":
                    save();
                    break;
                case "6":
                    load();
                    break;
                case "0":
                    System.out.println("\nüëã ¬°Gracias por usar la Agenda Telef√≥nica!");
                    System.out.println("üíæ Los cambios se han guardado autom√°ticamente.");
                    running = false;
                    break;
                default:
                    System.out.println("‚ùå Opci√≥n no v√°lida. Por favor, seleccione una opci√≥n del 0 al 6.");
            }
            
            if (running) {
                System.out.println("\nPresione Enter para continuar...");
                scanner.nextLine();
            }
        }
        
        scanner.close();
    }

    /**
     * M√©todo main - Punto de entrada del programa
     */
    public static void main(String[] args) {
        String fileName = "contactos.csv";
        
        // Permitir especificar un archivo diferente como argumento
        if (args.length > 0) {
            fileName = args[0];
        }
        
        AddressBook addressBook = new AddressBook(fileName);
        addressBook.showMenu();
    }
}
